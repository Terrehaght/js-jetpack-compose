<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MainActivity App</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        #app { 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
        }
        .fragment-container {
            flex: 1;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Framework Scripts -->
    <script src="https://cdn.jsdelivr.net/gh/Terrehaght/js-jetpack-compose@main/js-jetpack-compose/layouts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Terrehaght/js-jetpack-compose@main/js-jetpack-compose/AndroidFramework.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Terrehaght/js-jetpack-compose@main/js-jetpack-compose/material-views.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Terrehaght/js-jetpack-compose@main/js-jetpack-compose/material-notifiers.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Terrehaght/js-jetpack-compose@main/js-jetpack-compose/bottom_nav.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Terrehaght/js-jetpack-compose@main/js-jetpack-compose/drawer_tools.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Terrehaght/js-jetpack-compose@main/js-jetpack-compose/tabs.js"></script>

    <script>
        const { Activity, Intent, Application, Fragment } = AndroidFramework;
        const { Column, Row, ScrollView } = AndroidLayouts;
        const { TextView, MaterialButton, MaterialToolbar, MaterialDrawer, BottomNavigation, TabLayout, Card } = AndroidComponents;

        // =============== FRAGMENTS ===============

        class TasksFragment extends Fragment {
            onCreateView(savedInstanceState) {
                return ScrollView({
                    width: 'match_parent',
                    height: 'match_parent'
                }, [
                    Column({
                        width: 'match_parent',
                        padding: 20,
                        gap: 16
                    }, [
                        Card({ variant: 'outlined', padding: 16 }, [
                            Column({ gap: 12 }, [
                                TextView({
                                    text: 'ðŸ“‹ Tasks Fragment',
                                    textSize: 24,
                                    textStyle: 'bold',
                                    textColor: '#6750a4'
                                }),
                                TextView({
                                    text: 'This fragment displays all your active tasks. You can create, edit, and manage your to-do items here.',
                                    textSize: 14,
                                    textColor: '#666'
                                })
                            ])
                        ]),
                        Card({ variant: 'elevated', padding: 16 }, [
                            Column({ gap: 8 }, [
                                TextView({ text: 'Sample Task 1', textStyle: 'bold' }),
                                TextView({ text: 'Due: Today', textSize: 12, textColor: '#888' })
                            ])
                        ]),
                        Card({ variant: 'elevated', padding: 16 }, [
                            Column({ gap: 8 }, [
                                TextView({ text: 'Sample Task 2', textStyle: 'bold' }),
                                TextView({ text: 'Due: Tomorrow', textSize: 12, textColor: '#888' })
                            ])
                        ])
                    ])
                ]);
            }
        }

        class CompletedFragment extends Fragment {
            onCreateView(savedInstanceState) {
                return ScrollView({
                    width: 'match_parent',
                    height: 'match_parent'
                }, [
                    Column({
                        width: 'match_parent',
                        padding: 20,
                        gap: 16
                    }, [
                        Card({ variant: 'outlined', padding: 16 }, [
                            Column({ gap: 12 }, [
                                TextView({
                                    text: 'âœ… Completed Fragment',
                                    textSize: 24,
                                    textStyle: 'bold',
                                    textColor: '#2e7d32'
                                }),
                                TextView({
                                    text: 'View all your completed tasks here. Track your progress and review finished items.',
                                    textSize: 14,
                                    textColor: '#666'
                                })
                            ])
                        ]),
                        Card({ variant: 'filled', padding: 16 }, [
                            Column({ gap: 8 }, [
                                TextView({ text: 'âœ“ Completed Task 1', textStyle: 'bold' }),
                                TextView({ text: 'Completed: Yesterday', textSize: 12, textColor: '#888' })
                            ])
                        ])
                    ])
                ]);
            }
        }

        class GroupsFragment extends Fragment {
            onCreateView(savedInstanceState) {
                return ScrollView({
                    width: 'match_parent',
                    height: 'match_parent'
                }, [
                    Column({
                        width: 'match_parent',
                        padding: 20,
                        gap: 16
                    }, [
                        Card({ variant: 'outlined', padding: 16 }, [
                            Column({ gap: 12 }, [
                                TextView({
                                    text: 'ðŸ‘¥ Groups Fragment',
                                    textSize: 24,
                                    textStyle: 'bold',
                                    textColor: '#d84315'
                                }),
                                TextView({
                                    text: 'Manage and collaborate with your groups. Create new groups or join existing ones.',
                                    textSize: 14,
                                    textColor: '#666'
                                })
                            ])
                        ]),
                        Card({ variant: 'elevated', padding: 16 }, [
                            Column({ gap: 8 }, [
                                TextView({ text: 'Team Project Alpha', textStyle: 'bold' }),
                                TextView({ text: '5 members', textSize: 12, textColor: '#888' })
                            ])
                        ]),
                        Card({ variant: 'elevated', padding: 16 }, [
                            Column({ gap: 8 }, [
                                TextView({ text: 'Design Squad', textStyle: 'bold' }),
                                TextView({ text: '8 members', textSize: 12, textColor: '#888' })
                            ])
                        ])
                    ])
                ]);
            }
        }

        class WalletFragment extends Fragment {
            onCreateView(savedInstanceState) {
                return ScrollView({
                    width: 'match_parent',
                    height: 'match_parent'
                }, [
                    Column({
                        width: 'match_parent',
                        padding: 20,
                        gap: 16
                    }, [
                        Card({ variant: 'outlined', padding: 16 }, [
                            Column({ gap: 12 }, [
                                TextView({
                                    text: 'ðŸ’° Wallet Fragment',
                                    textSize: 24,
                                    textStyle: 'bold',
                                    textColor: '#f57c00'
                                }),
                                TextView({
                                    text: 'Manage your finances, view transactions, and track your expenses here.',
                                    textSize: 14,
                                    textColor: '#666'
                                })
                            ])
                        ]),
                        Card({ variant: 'filled', padding: 20, background: '#6750a4' }, [
                            Column({ gap: 8 }, [
                                TextView({ text: 'Current Balance', textSize: 12, textColor: '#fff' }),
                                TextView({ text: '$1,234.56', textSize: 32, textStyle: 'bold', textColor: '#fff' })
                            ])
                        ]),
                        Card({ variant: 'elevated', padding: 16 }, [
                            Column({ gap: 8 }, [
                                TextView({ text: 'Recent Transaction', textStyle: 'bold' }),
                                TextView({ text: '-$45.00 â€¢ Coffee Shop', textSize: 12, textColor: '#888' })
                            ])
                        ])
                    ])
                ]);
            }
        }

        class ProfileFragment extends Fragment {
            onCreateView(savedInstanceState) {
                return ScrollView({
                    width: 'match_parent',
                    height: 'match_parent'
                }, [
                    Column({
                        width: 'match_parent',
                        padding: 20,
                        gap: 16
                    }, [
                        Card({ variant: 'outlined', padding: 16 }, [
                            Column({ gap: 12 }, [
                                TextView({
                                    text: 'ðŸ‘¤ Profile Fragment',
                                    textSize: 24,
                                    textStyle: 'bold',
                                    textColor: '#1976d2'
                                }),
                                TextView({
                                    text: 'View and edit your profile information, settings, and preferences.',
                                    textSize: 14,
                                    textColor: '#666'
                                })
                            ])
                        ]),
                        Card({ variant: 'elevated', padding: 16 }, [
                            Column({ gap: 12 }, [
                                TextView({ text: 'John Doe', textSize: 20, textStyle: 'bold' }),
                                TextView({ text: 'john.doe@example.com', textSize: 14, textColor: '#666' }),
                                TextView({ text: 'Member since 2024', textSize: 12, textColor: '#888' })
                            ])
                        ])
                    ])
                ]);
            }
        }

        // =============== MAIN ACTIVITY ===============

        class MainActivity extends Activity {
            constructor() {
                super();
                this.currentFragment = null;
                this.drawer = null;
                this.bottomNav = null;
                this.drawerElement = null;
            }

            onCreate(savedInstanceState) {
                super.onCreate(savedInstanceState);

                // Create TabLayout for drawer
                const drawerTabLayout = TabLayout({
                    tabs: [
                        { text: 'Application', icon: 'bx bx-grid-alt' },
                        { text: 'Posts', icon: 'bx bx-message-square-dots' },
                        { text: 'Employees', icon: 'bx bx-user-circle' }
                    ],
                    pages: [
                        // Application Tab
                        Column({ padding: 16, gap: 12 }, [
                            TextView({ text: 'Application Settings', textStyle: 'bold', textSize: 16 }),
                            MaterialButton({ 
                                text: 'App Configuration', 
                                variant: 'outlined',
                                onClick: () => this.toast('Opening App Config')
                            }),
                            MaterialButton({ 
                                text: 'System Settings', 
                                variant: 'outlined',
                                onClick: () => this.toast('Opening System Settings')
                            })
                        ]),
                        // Posts Tab
                        Column({ padding: 16, gap: 12 }, [
                            TextView({ text: 'Posts Management', textStyle: 'bold', textSize: 16 }),
                            MaterialButton({ 
                                text: 'Create New Post', 
                                variant: 'outlined',
                                onClick: () => this.toast('Creating new post')
                            }),
                            MaterialButton({ 
                                text: 'View All Posts', 
                                variant: 'outlined',
                                onClick: () => this.toast('Viewing all posts')
                            })
                        ]),
                        // Employees Tab
                        Column({ padding: 16, gap: 12 }, [
                            TextView({ text: 'Employee Directory', textStyle: 'bold', textSize: 16 }),
                            MaterialButton({ 
                                text: 'Add Employee', 
                                variant: 'outlined',
                                onClick: () => this.toast('Adding new employee')
                            }),
                            MaterialButton({ 
                                text: 'Employee List', 
                                variant: 'outlined',
                                onClick: () => this.toast('Viewing employees')
                            })
                        ])
                    ],
                    mode: 'fixed',
                    style: 'primary'
                });

                // Get the tab layout element
                const tabElement = drawerTabLayout.getElement ? drawerTabLayout.getElement() : drawerTabLayout;

                // Create drawer - handle different return types
                const drawerConfig = {
                    position: 'left',
                    header: {
                        title: 'Navigation Menu',
                        subtitle: 'Select a section'
                    }
                };

                // MaterialDrawer might return the drawer object or just an element
                this.drawer = MaterialDrawer(drawerConfig);
                
                // Get the actual drawer DOM element
                if (this.drawer && typeof this.drawer === 'object') {
                    // If it returns an object with methods
                    this.drawerElement = this.drawer.element || this.drawer.getElement?.() || this.drawer;
                } else {
                    // If it returns a raw element
                    this.drawerElement = this.drawer;
                }

                // Find drawer content area and append tab layout
                setTimeout(() => {
                    const drawerContent = document.querySelector('.drawer-content') || 
                                        document.querySelector('[class*="drawer"]');
                    if (drawerContent && tabElement) {
                        drawerContent.innerHTML = '';
                        drawerContent.appendChild(tabElement);
                    }
                }, 100);

                // Create toolbar
                const toolbar = MaterialToolbar({
                    title: 'MainActivity',
                    navigationIcon: 'bx bx-menu',
                    onNavigationClick: () => {
                        if (this.drawer && typeof this.drawer.open === 'function') {
                            this.drawer.open();
                        } else {
                            // Fallback: manually toggle drawer
                            const drawerEl = document.querySelector('[class*="drawer"]');
                            if (drawerEl) {
                                drawerEl.classList.toggle('open');
                            }
                        }
                    },
                    actions: [
                        { 
                            icon: 'bx bx-search', 
                            onClick: () => this.toast('Search clicked')
                        },
                        { 
                            icon: 'bx bx-bell', 
                            badge: '3',
                            onClick: () => this.toast('3 notifications')
                        }
                    ]
                });

                // Get toolbar element
                const toolbarElement = toolbar.getElement ? toolbar.getElement() : toolbar;

                // Create fragment container
                const fragmentContainer = document.createElement('div');
                fragmentContainer.id = 'fragment-container';
                fragmentContainer.className = 'fragment-container';

                // Create bottom navigation
                this.bottomNav = BottomNavigation()
                    .setItems([
                        { id: 'tasks', name: 'Tasks', icon: 'bx bx-task' },
                        { id: 'completed', name: 'Completed', icon: 'bx bx-check-circle' },
                        { id: 'groups', name: 'Groups', icon: 'bx bx-group' },
                        { id: 'wallet', name: 'Wallet', icon: 'bx bx-wallet' },
                        { id: 'profile', name: 'Profile', icon: 'bx bx-user' }
                    ])
                    .setOnItemSelect((id) => this.handleBottomNavClick(id))
                    .setItemColor('#6750a4');

                // Build main layout
                const mainLayout = Column({
                    width: 'match_parent',
                    height: 'match_parent',
                    gap: 0
                }, []);

                const mainElement = mainLayout.getElement();
                
                // Append toolbar
                if (toolbarElement instanceof HTMLElement) {
                    mainElement.appendChild(toolbarElement);
                } else {
                    console.error('Toolbar element is not valid');
                }

                // Append fragment container
                mainElement.appendChild(fragmentContainer);
                
                // Append bottom navigation
                const bottomNavElement = this.bottomNav.getElement ? 
                                        this.bottomNav.getElement() : 
                                        this.bottomNav.element || 
                                        this.bottomNav;
                
                if (bottomNavElement instanceof HTMLElement) {
                    mainElement.appendChild(bottomNavElement);
                } else {
                    console.warn('Bottom navigation element not found, waiting...');
                    // Retry after a short delay
                    setTimeout(() => {
                        const navEl = document.querySelector('[class*="bottom-nav"]');
                        if (navEl && !mainElement.contains(navEl)) {
                            mainElement.appendChild(navEl);
                        }
                    }, 100);
                }

                this.setContentView(mainLayout);

                // Load initial fragment (Tasks)
                this.loadFragment(new TasksFragment(), 'tasks');
                
                // Set initial selection
                if (this.bottomNav.setSelected) {
                    this.bottomNav.setSelected('tasks');
                }

                // Show bottom nav
                setTimeout(() => {
                    if (this.bottomNav.show) {
                        this.bottomNav.show();
                    }
                }, 150);
            }

            handleBottomNavClick(id) {
                let fragment;
                switch(id) {
                    case 'tasks':
                        fragment = new TasksFragment();
                        break;
                    case 'completed':
                        fragment = new CompletedFragment();
                        break;
                    case 'groups':
                        fragment = new GroupsFragment();
                        break;
                    case 'wallet':
                        fragment = new WalletFragment();
                        break;
                    case 'profile':
                        fragment = new ProfileFragment();
                        break;
                }
                if (fragment) {
                    this.loadFragment(fragment, id);
                }
            }

            loadFragment(fragment, tag) {
                this.getSupportFragmentManager()
                    .beginTransaction()
                    .replace('fragment-container', fragment, tag)
                    .commit();
                
                this.currentFragment = fragment;
            }

            onBackPressed() {
                // Check if drawer is open using multiple methods
                const isDrawerOpen = (this.drawer && typeof this.drawer.isOpen === 'function' && this.drawer.isOpen()) ||
                                    (this.drawerElement && this.drawerElement.classList.contains('open')) ||
                                    document.querySelector('[class*="drawer"].open');
                
                if (isDrawerOpen) {
                    if (this.drawer && typeof this.drawer.close === 'function') {
                        this.drawer.close();
                    } else {
                        // Fallback
                        const drawerEl = document.querySelector('[class*="drawer"]');
                        if (drawerEl) {
                            drawerEl.classList.remove('open');
                        }
                    }
                    return;
                }
                
                // Navigate to previous activity using Intent
                // Example: const intent = new Intent(HomeActivity);
                // this.startActivity(intent);
                
                this.toast('Back pressed - Use Intent to navigate to previous activity');
            }

            onResume() {
                super.onResume();
                // Show bottom nav when activity resumes
                setTimeout(() => {
                    if (this.bottomNav && this.bottomNav.show) {
                        this.bottomNav.show();
                    }
                }, 50);
            }
        }

        // Setup back button handling
        Application.setupBackButton();

        // Launch the application
        Application.launch(MainActivity);
    </script>
</body>
</html>